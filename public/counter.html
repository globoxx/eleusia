<!DOCTYPE html>
<html>
  <head>
    <title>Time to play !></span></title>
  </head>
  <body>
    <h1>Room <span id="room"></span></h1>
    <p>Counter: <span id="counter">0</span></p>
    <p>Score: <span id="score">0</span></p> 
    <button id="button">Click me!</button>

    <p id="message"></p>

    <p>Timer: <span id="timer"></span></p>

    <table id="leaderBoard">
      <thead>
        <tr>
          <th>Pseudo</th>
          <th>Score</th>
        </tr>
      </thead>
      <tbody id="testBody"></tbody>
    </table>

    <div id="game-controls">
      <button id="start-button" style="display: none;">Start game</button>
    </div>

    <script src="/socket.io/socket.io.js"></script>
    <script>
      const socket = io();
      const url_search_params = new URLSearchParams(window.location.search);
      const roomId = url_search_params.get('room');
      const pseudo = url_search_params.get('pseudo');
      let score = 0;
      let timer = 30;

      socket.emit('joinRoom', roomId, pseudo);

      document.getElementById('room').textContent = roomId;

      function loadTableData(users) {
        const table = document.getElementById("testBody");
        table.innerHTML = '';
        for (const [user_pseudo, user_data] of Object.entries(users)) {
          let row = table.insertRow(-1);
          let pseudo_cell = row.insertCell(0);
          pseudo_cell.innerHTML = user_pseudo;
          let score_cell = row.insertCell(1);
          score_cell.innerHTML = user_data['score'];
        };
      }

      socket.on('roomJoined', (data) => {
        counter = data['counter']
        loadTableData(data['users']);
        document.getElementById('counter').textContent = counter;
        const is_creator = pseudo === data['creator'];
        if (is_creator) {
            document.getElementById('message').textContent = "Bienvenue créateur !";
            document.getElementById('start-button').style.display = 'block';
        } else {
            document.getElementById('message').textContent = "Vous êtes un simple utilisateur !";
        }
      });

      socket.on(`counter`, (data) => {
        counter = data['counter']
        score = data['users'][pseudo]['score']
        loadTableData(data['users']);
        document.getElementById('counter').textContent = counter;
        document.getElementById('score').textContent = score;
      });

      socket.on(`timer`, (timer) => {
        document.getElementById('timer').textContent = timer;
      });

      document.getElementById('button').addEventListener('click', () => {
        socket.emit('buttonClick', roomId, pseudo);
      });

      document.getElementById('start-button').addEventListener('click', () => {
        socket.emit('startGame', roomId);
        document.getElementById('start-button').style.display = 'none';
      });
    </script>
  </body>
</html>
