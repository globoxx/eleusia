{"ast":null,"code":"import _createForOfIteratorHelper from \"C:/Users/vince/OneDrive/Documents/GitHub/eleusia/node_modules/@babel/runtime/helpers/esm/createForOfIteratorHelper.js\";\n/**\n * @license\n * Copyright 2021 Google LLC. All Rights Reserved.\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n * http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n * =============================================================================\n */\nimport { backend_util, Einsum, util } from '@tensorflow/tfjs-core';\nimport { multiply } from './Multiply';\nimport { reshape } from './Reshape';\nimport { sum } from './Sum';\nimport { transpose } from './Transpose';\nexport function einsum(args) {\n  var inputs = args.inputs,\n    backend = args.backend,\n    attrs = args.attrs;\n  var equation = attrs.equation;\n  var tensors = inputs;\n  var _backend_util$decodeE = backend_util.decodeEinsumEquation(equation, tensors.length),\n    allDims = _backend_util$decodeE.allDims,\n    summedDims = _backend_util$decodeE.summedDims,\n    idDims = _backend_util$decodeE.idDims;\n  backend_util.checkEinsumDimSizes(allDims.length, idDims, tensors);\n  var _backend_util$getEins = backend_util.getEinsumComputePath(summedDims, idDims),\n    path = _backend_util$getEins.path,\n    steps = _backend_util$getEins.steps;\n  var nSteps = steps.length;\n  var out = null;\n  var numDimsRemaining = allDims.length;\n  var tensorsToDispose = [];\n  for (var i = 0; i < nSteps; ++i) {\n    var _iterator = _createForOfIteratorHelper(steps[i]),\n      _step;\n    try {\n      for (_iterator.s(); !(_step = _iterator.n()).done;) {\n        var idTerm = _step.value;\n        var _backend_util$getEins2 = backend_util.getEinsumPermutation(numDimsRemaining, idDims[idTerm]),\n          perm = _backend_util$getEins2.permutationIndices,\n          dimsToExpand = _backend_util$getEins2.expandDims;\n        var x = void 0;\n        if (backend_util.isIdentityPermutation(perm)) {\n          x = tensors[idTerm];\n        } else {\n          x = transpose({\n            inputs: {\n              x: tensors[idTerm]\n            },\n            backend: backend,\n            attrs: {\n              perm: perm\n            }\n          });\n          tensorsToDispose.push(x);\n        }\n        var targetShape = x.shape.slice();\n        for (var k = 0; k < dimsToExpand.length; ++k) {\n          targetShape.splice(dimsToExpand[k], 0, 1);\n        }\n        if (!util.arraysEqual(x.shape, targetShape)) {\n          x = reshape({\n            inputs: {\n              x: x\n            },\n            backend: backend,\n            attrs: {\n              shape: targetShape\n            }\n          });\n          tensorsToDispose.push(x);\n        }\n        if (out === null) {\n          out = x;\n        } else {\n          // tslint:disable-next-line: no-unnecessary-type-assertion\n          out = multiply({\n            inputs: {\n              a: x,\n              b: out\n            },\n            backend: backend\n          });\n          tensorsToDispose.push(out);\n        }\n      }\n    } catch (err) {\n      _iterator.e(err);\n    } finally {\n      _iterator.f();\n    }\n    if (i < nSteps - 1) {\n      if (path[i] >= 0) {\n        out = sum({\n          inputs: {\n            x: out\n          },\n          backend: backend,\n          attrs: {\n            axis: path[i] - (allDims.length - numDimsRemaining),\n            keepDims: false\n          }\n        });\n        tensorsToDispose.push(out);\n      }\n      numDimsRemaining--;\n    }\n  }\n  // Clean up intermediate tensors.\n  for (var _i = 0, _tensorsToDispose = tensorsToDispose; _i < _tensorsToDispose.length; _i++) {\n    var tensorInfo = _tensorsToDispose[_i];\n    if (tensorInfo === out) {\n      continue;\n    }\n    backend.disposeIntermediateTensorInfo(tensorInfo);\n  }\n  return out;\n}\nexport var einsumConfig = {\n  kernelName: Einsum,\n  backendName: 'cpu',\n  kernelFunc: einsum\n};","map":{"version":3,"names":["backend_util","Einsum","util","multiply","reshape","sum","transpose","einsum","args","inputs","backend","attrs","equation","tensors","_backend_util$decodeE","decodeEinsumEquation","length","allDims","summedDims","idDims","checkEinsumDimSizes","_backend_util$getEins","getEinsumComputePath","path","steps","nSteps","out","numDimsRemaining","tensorsToDispose","i","_iterator","_createForOfIteratorHelper","_step","s","n","done","idTerm","value","_backend_util$getEins2","getEinsumPermutation","perm","permutationIndices","dimsToExpand","expandDims","x","isIdentityPermutation","push","targetShape","shape","slice","k","splice","arraysEqual","a","b","err","e","f","axis","keepDims","_i","_tensorsToDispose","tensorInfo","disposeIntermediateTensorInfo","einsumConfig","kernelName","backendName","kernelFunc"],"sources":["C:\\Users\\vince\\OneDrive\\Documents\\GitHub\\tfjs-backend-cpu\\src\\kernels\\Einsum.ts"],"sourcesContent":["/**\n * @license\n * Copyright 2021 Google LLC. All Rights Reserved.\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n * http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n * =============================================================================\n */\n\nimport {backend_util, Einsum, EinsumAttrs, EinsumInputs, KernelConfig, KernelFunc, Tensor, TensorInfo, util} from '@tensorflow/tfjs-core';\n\nimport {MathBackendCPU} from '../backend_cpu';\n\nimport {multiply} from './Multiply';\nimport {reshape} from './Reshape';\nimport {sum} from './Sum';\nimport {transpose} from './Transpose';\n\nexport function einsum(\n    args: {inputs: EinsumInputs, backend: MathBackendCPU, attrs: EinsumAttrs}):\n    TensorInfo {\n  const {inputs, backend, attrs} = args;\n  const {equation} = attrs;\n  const tensors = inputs as Tensor[];\n\n  const {allDims, summedDims, idDims} =\n      backend_util.decodeEinsumEquation(equation, tensors.length);\n  backend_util.checkEinsumDimSizes(allDims.length, idDims, tensors);\n  const {path, steps} = backend_util.getEinsumComputePath(summedDims, idDims);\n\n  const nSteps = steps.length;\n  let out: TensorInfo|null = null;\n  let numDimsRemaining = allDims.length;\n  const tensorsToDispose: TensorInfo[] = [];\n  for (let i = 0; i < nSteps; ++i) {\n    for (const idTerm of steps[i]) {\n      const {permutationIndices: perm, expandDims: dimsToExpand} =\n          backend_util.getEinsumPermutation(numDimsRemaining, idDims[idTerm]);\n      let x: TensorInfo;\n      if (backend_util.isIdentityPermutation(perm)) {\n        x = tensors[idTerm];\n      } else {\n        x = transpose({inputs: {x: tensors[idTerm]}, backend, attrs: {perm}});\n        tensorsToDispose.push(x);\n      }\n      const targetShape: number[] = x.shape.slice();\n      for (let k = 0; k < dimsToExpand.length; ++k) {\n        targetShape.splice(dimsToExpand[k], 0, 1);\n      }\n\n      if (!util.arraysEqual(x.shape, targetShape)) {\n        x = reshape({inputs: {x}, backend, attrs: {shape: targetShape}});\n        tensorsToDispose.push(x);\n      }\n      if (out === null) {\n        out = x;\n      } else {\n        // tslint:disable-next-line: no-unnecessary-type-assertion\n        out = multiply({inputs: {a: x, b: out}, backend}) as TensorInfo;\n        tensorsToDispose.push(out);\n      }\n    }\n    if (i < nSteps - 1) {\n      if (path[i] >= 0) {\n        out = sum({\n          inputs: {x: out},\n          backend,\n          attrs: {\n            axis: path[i] - (allDims.length - numDimsRemaining),\n            keepDims: false\n          }\n        });\n        tensorsToDispose.push(out);\n      }\n      numDimsRemaining--;\n    }\n  }\n\n  // Clean up intermediate tensors.\n  for (const tensorInfo of tensorsToDispose) {\n    if (tensorInfo === out) {\n      continue;\n    }\n    backend.disposeIntermediateTensorInfo(tensorInfo);\n  }\n\n  return out;\n}\n\nexport const einsumConfig: KernelConfig = {\n  kernelName: Einsum,\n  backendName: 'cpu',\n  kernelFunc: einsum as unknown as KernelFunc\n};\n"],"mappings":"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"},"metadata":{},"sourceType":"module","externalDependencies":[]}